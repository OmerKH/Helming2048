name: CI/CD for 2048 Chart

on:
  push:
    branches: [ "master" ]
    # tags: [ 'v*.*.*' ]
  pull_request:
    branches: [ "master" ]



jobs:
  lint-and-docs:
    name: Lint & Docs Check
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repo
        uses: actions/checkout@v3

      - name: Set up Helm
        uses: azure/setup-helm@v3
        with:
          version: v3.12.3

      - name: Helm lint
        run: helm lint 2048-chart

      - name: Check README is up-to-date
        run: |
          if ! grep -q "2048" README.md; then
            echo "README check failed"
            exit 1
          fi

  deploy:
    name: ðŸš€ Deploy on Merge
    if: github.event_name == 'push'
    needs: lint-and-docs
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repo
        uses: actions/checkout@v3

      - name: Set up Helm
        uses: azure/setup-helm@v3
        with:
          version: v3.12.3

      - name: Set up Kubeconfig from secret
        env:
          KUBECONFIG_DATA: ${{ secrets.KUBECONFIG_DATA }}
        run: |
          echo "$KUBECONFIG_DATA" | base64 -d > kubeconfig
          export KUBECONFIG=$PWD/kubeconfig
          kubectl get nodes

      - name: Helm upgrade
        run: |
          helm upgrade --install 2048 ./2048-chart --namespace default